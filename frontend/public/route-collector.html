<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚°ì±…ë¡œ ë£¨íŠ¸ ìˆ˜ì§‘ê¸°</title>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=39b1c3de3df8e86c8abdd3853ac4effe&libraries=services"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        .header {
            background: #4285f4;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .controls {
            padding: 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            text-align: center;
        }
        
        .btn {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-start { background: #4CAF50; color: white; }
        .btn-stop { background: #f44336; color: white; }
        .btn-clear { background: #ff9800; color: white; }
        .btn-copy { background: #2196F3; color: white; }
        
        #map {
            width: 100%;
            height: 500px;
        }
        
        .output {
            padding: 15px;
            background: #f9f9f9;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 5px;
            text-align: center;
        }
        
        .coords-output {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ—ºï¸ ì‚°ì±…ë¡œ ë£¨íŠ¸ ì¢Œí‘œ ìˆ˜ì§‘ê¸°</h1>
        <p>ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì‚°ì±…ë¡œ ê²½ë¡œì˜ ì¢Œí‘œë¥¼ ìˆ˜ì§‘í•˜ì„¸ìš”</p>
    </div>
    
    <div class="controls">
        <div class="search-section">
            <input type="text" id="searchInput" placeholder="ì£¼ì†Œë‚˜ ì¥ì†Œëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê²½ì¶˜ì„ ìˆ²ê¸¸, ì„œìš¸ì‹œ ë™ëŒ€ë¬¸êµ¬ íšŒê¸°ë™)" 
                   style="width: 400px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
            <button id="searchBtn" class="btn" style="background: #9C27B0; color: white;">ğŸ” ê²€ìƒ‰</button>
        </div>
        <div style="margin-top: 10px;">
            <button id="startBtn" class="btn btn-start">ğŸš€ ìˆ˜ì§‘ ì‹œì‘</button>
            <button id="stopBtn" class="btn btn-stop" disabled>â¹ï¸ ìˆ˜ì§‘ ì¤‘ì§€</button>
            <button id="clearBtn" class="btn btn-clear">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
            <button id="copyBtn" class="btn btn-copy">ğŸ“‹ ì¢Œí‘œ ë³µì‚¬</button>
        </div>
    </div>
    
    <div id="map"></div>
    
    <div class="output">
        <div id="status" class="status">
            ìˆ˜ì§‘ ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ì¢Œí‘œê°€ ê¸°ë¡ë©ë‹ˆë‹¤.
        </div>
        
        <div>
            <strong>ìˆ˜ì§‘ëœ ì¢Œí‘œ (<span id="coordCount">0</span>ê°œ):</strong>
            <div id="coordsOutput" class="coords-output">ì¢Œí‘œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map;
        let routeCoords = [];
        let markers = [];
        let polyline = null;
        let isCollecting = false;

        // DOM ìš”ì†Œ
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const copyBtn = document.getElementById('copyBtn');
        const searchBtn = document.getElementById('searchBtn');
        const searchInput = document.getElementById('searchInput');
        const status = document.getElementById('status');
        const coordsOutput = document.getElementById('coordsOutput');
        const coordCount = document.getElementById('coordCount');

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ì‹œì²­
                level: 5
            };
            
            map = new kakao.maps.Map(container, options);
            
            // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
            kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                if (!isCollecting) return;
                
                const latlng = mouseEvent.latLng;
                const lat = latlng.getLat();
                const lng = latlng.getLng();
                
                addRoutePoint(lat, lng, latlng);
            });
        }

        // ë£¨íŠ¸ í¬ì¸íŠ¸ ì¶”ê°€
        function addRoutePoint(lat, lng, latlng) {
            // ì¢Œí‘œ ë°°ì—´ì— ì¶”ê°€ (GeoJSON í˜•ì‹: [ê²½ë„, ìœ„ë„])
            routeCoords.push([lng, lat]);
            
            // ë§ˆì»¤ ì¶”ê°€
            const marker = new kakao.maps.Marker({
                position: latlng,
                map: map
            });
            markers.push(marker);
            
            // í´ë¦¬ë¼ì¸ ì—…ë°ì´íŠ¸
            updatePolyline();
            
            // UI ì—…ë°ì´íŠ¸
            updateUI();
            
            console.log(`ğŸ“ ì  ${routeCoords.length}: [${lng}, ${lat}]`);
        }

        // í´ë¦¬ë¼ì¸ ì—…ë°ì´íŠ¸
        function updatePolyline() {
            // ê¸°ì¡´ í´ë¦¬ë¼ì¸ ì œê±°
            if (polyline) {
                polyline.setMap(null);
            }
            
            if (routeCoords.length < 2) return;
            
            // ì¹´ì¹´ì˜¤ë§µ ì¢Œí‘œ ë°°ì—´ë¡œ ë³€í™˜
            const path = routeCoords.map(coord => new kakao.maps.LatLng(coord[1], coord[0]));
            
            // ìƒˆ í´ë¦¬ë¼ì¸ ìƒì„±
            polyline = new kakao.maps.Polyline({
                path: path,
                strokeWeight: 5,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeStyle: 'solid'
            });
            
            polyline.setMap(map);
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            coordCount.textContent = routeCoords.length;
            
            if (routeCoords.length === 0) {
                coordsOutput.textContent = 'ì¢Œí‘œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...';
            } else {
                // GeoJSON í˜•ì‹ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                const geoJsonFormat = {
                    type: "LineString",
                    coordinates: routeCoords
                };
                
                // Firebase í˜¸í™˜ í˜•ì‹ë„ í•¨ê»˜ í‘œì‹œ
                const firebaseFormat = {
                    type: "LineString",
                    coordinates: routeCoords.map((coord, index) => ({
                        lng: coord[0],
                        lat: coord[1],
                        order: index
                    }))
                };
                
                const displayText = `// ğŸ“‹ ë³µì‚¬ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì•„ë˜ í˜•ì‹ë“¤ì´ ëª¨ë‘ ë³µì‚¬ë©ë‹ˆë‹¤

// 1ï¸âƒ£ GeoJSON í˜•ì‹ (í‘œì¤€)
${JSON.stringify(geoJsonFormat, null, 2)}

// 2ï¸âƒ£ Firebase í˜¸í™˜ í˜•ì‹
${JSON.stringify(firebaseFormat, null, 2)}

// 3ï¸âƒ£ Python ì½”ë“œ
route_data = ${JSON.stringify(geoJsonFormat, null, 2)}
add_route_to_trail("ì‚°ì±…ë¡œì´ë¦„", route_data)`;
                
                coordsOutput.textContent = displayText;
            }
        }

        // ìˆ˜ì§‘ ì‹œì‘
        function startCollection() {
            isCollecting = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            status.textContent = 'ğŸŸ¢ ìˆ˜ì§‘ ì¤‘... ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ê²½ë¡œë¥¼ ë§Œë“œì„¸ìš”!';
            status.style.background = '#c8e6c9';
        }

        // ìˆ˜ì§‘ ì¤‘ì§€
        function stopCollection() {
            isCollecting = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            status.textContent = `âœ… ìˆ˜ì§‘ ì™„ë£Œ! ì´ ${routeCoords.length}ê°œì˜ ì¢Œí‘œê°€ ìˆ˜ì§‘ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            status.style.background = '#e3f2fd';
        }

        // ì´ˆê¸°í™”
        function clearAll() {
            routeCoords = [];
            
            // ë§ˆì»¤ ì œê±°
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            
            // í´ë¦¬ë¼ì¸ ì œê±°
            if (polyline) {
                polyline.setMap(null);
                polyline = null;
            }
            
            updateUI();
            status.textContent = 'ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
            status.style.background = '#fff3e0';
        }

        // ì¢Œí‘œ ë³µì‚¬ (Firebase í˜¸í™˜ í˜•ì‹)
        function copyCoords() {
            if (routeCoords.length === 0) {
                alert('ë³µì‚¬í•  ì¢Œí‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë‘ ê°€ì§€ í˜•ì‹ ì œê³µ
            const geoJsonFormat = {
                type: "LineString",
                coordinates: routeCoords
            };
            
            // Firebase í˜¸í™˜ ê°ì²´ í˜•ì‹
            const firebaseFormat = {
                type: "LineString",
                coordinates: routeCoords.map((coord, index) => ({
                    lng: coord[0],
                    lat: coord[1], 
                    order: index
                }))
            };
            
            const output = `// GeoJSON í˜•ì‹ (í‘œì¤€)
${JSON.stringify(geoJsonFormat, null, 2)}

// Firebase í˜¸í™˜ í˜•ì‹ (ì‹¤ì œ ì‚¬ìš©)
${JSON.stringify(firebaseFormat, null, 2)}

// Python ì½”ë“œ ì˜ˆì‹œ:
route_data = ${JSON.stringify(geoJsonFormat, null, 2)}
add_route_to_trail("ì‚°ì±…ë¡œì´ë¦„", route_data)`;
            
            navigator.clipboard.writeText(output).then(() => {
                alert(`âœ… ${routeCoords.length}ê°œ ì¢Œí‘œê°€ ë‘ ê°€ì§€ í˜•ì‹ìœ¼ë¡œ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n- GeoJSON í˜•ì‹ (í‘œì¤€)\n- Firebase í˜¸í™˜ í˜•ì‹\n- Python ì½”ë“œ ì˜ˆì‹œ`);
            }).catch(() => {
                // ë³µì‚¬ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ ì„ íƒ
                const range = document.createRange();
                range.selectNode(coordsOutput);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
                alert('ì¢Œí‘œ ë°ì´í„°ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. Ctrl+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”.');
            });
        }

        // ì£¼ì†Œ ê²€ìƒ‰ ê¸°ëŠ¥
        function searchLocation() {
            const query = searchInput.value.trim();
            if (!query) {
                alert('ê²€ìƒ‰í•  ì£¼ì†Œë‚˜ ì¥ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            status.textContent = 'ğŸ” ê²€ìƒ‰ ì¤‘...';
            status.style.background = '#fff3e0';

            // ì¹´ì¹´ì˜¤ë§µ Places API ì‚¬ìš©
            const ps = new kakao.maps.services.Places();
            
            // í‚¤ì›Œë“œë¡œ ì¥ì†Œ ê²€ìƒ‰
            ps.keywordSearch(query, (data, status_code) => {
                if (status_code === kakao.maps.services.Status.OK && data.length > 0) {
                    // ì²« ë²ˆì§¸ ê²€ìƒ‰ ê²°ê³¼ ì‚¬ìš©
                    const place = data[0];
                    const lat = parseFloat(place.y);
                    const lng = parseFloat(place.x);
                    
                    // ì§€ë„ ì´ë™
                    const moveLatLng = new kakao.maps.LatLng(lat, lng);
                    map.setCenter(moveLatLng);
                    map.setLevel(3); // ìƒì„¸ ë ˆë²¨ë¡œ ì„¤ì •
                    
                    // ê²€ìƒ‰ ê²°ê³¼ ë§ˆì»¤ í‘œì‹œ
                    const searchMarker = new kakao.maps.Marker({
                        position: moveLatLng,
                        map: map
                    });
                    
                    // ì •ë³´ì°½ í‘œì‹œ
                    const infoWindow = new kakao.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px; text-align: center;">
                                <strong>${place.place_name}</strong><br>
                                <small>${place.address_name}</small><br>
                                <small style="color: #666;">ê²€ìƒ‰ ê²°ê³¼</small>
                            </div>
                        `
                    });
                    
                    infoWindow.open(map, searchMarker);
                    
                    // 3ì´ˆ í›„ ê²€ìƒ‰ ë§ˆì»¤ ì œê±°
                    setTimeout(() => {
                        searchMarker.setMap(null);
                        infoWindow.close();
                    }, 3000);
                    
                    status.textContent = `âœ… "${place.place_name}" ê²€ìƒ‰ ì™„ë£Œ! ì§€ë„ê°€ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`;
                    status.style.background = '#e8f5e8';
                    
                } else {
                    // í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ ì£¼ì†Œ ê²€ìƒ‰ ì‹œë„
                    const geocoder = new kakao.maps.services.Geocoder();
                    
                    geocoder.addressSearch(query, (result, status_code) => {
                        if (status_code === kakao.maps.services.Status.OK && result.length > 0) {
                            const lat = parseFloat(result[0].y);
                            const lng = parseFloat(result[0].x);
                            
                            // ì§€ë„ ì´ë™
                            const moveLatLng = new kakao.maps.LatLng(lat, lng);
                            map.setCenter(moveLatLng);
                            map.setLevel(3);
                            
                            // ê²€ìƒ‰ ê²°ê³¼ ë§ˆì»¤ í‘œì‹œ
                            const searchMarker = new kakao.maps.Marker({
                                position: moveLatLng,
                                map: map
                            });
                            
                            // ì •ë³´ì°½ í‘œì‹œ
                            const infoWindow = new kakao.maps.InfoWindow({
                                content: `
                                    <div style="padding: 10px; text-align: center;">
                                        <strong>${result[0].address_name}</strong><br>
                                        <small style="color: #666;">ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼</small>
                                    </div>
                                `
                            });
                            
                            infoWindow.open(map, searchMarker);
                            
                            // 3ì´ˆ í›„ ê²€ìƒ‰ ë§ˆì»¤ ì œê±°
                            setTimeout(() => {
                                searchMarker.setMap(null);
                                infoWindow.close();
                            }, 3000);
                            
                            status.textContent = `âœ… "${result[0].address_name}" ê²€ìƒ‰ ì™„ë£Œ!`;
                            status.style.background = '#e8f5e8';
                            
                        } else {
                            status.textContent = `âŒ "${query}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                            status.style.background = '#ffebee';
                        }
                    });
                }
            });
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        startBtn.addEventListener('click', startCollection);
        stopBtn.addEventListener('click', stopCollection);
        clearBtn.addEventListener('click', clearAll);
        copyBtn.addEventListener('click', copyCoords);
        searchBtn.addEventListener('click', searchLocation);
        
        // ê²€ìƒ‰ì°½ì—ì„œ Enter í‚¤ ì…ë ¥ ì²˜ë¦¬
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchLocation();
            }
        });

        // ì´ˆê¸°í™”
        initMap();
        updateUI();
    </script>
</body>
</html>
